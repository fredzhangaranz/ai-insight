# Upgrade Strategy: Handling Version Changes

**Planning document for how InsightGen handles upgrades and migrations across versions.**

**Status:** Future Work (Next Iteration)  
**Date:** February 2026

---

## Overview

As InsightGen evolves, deployments will need to upgrade from one version to another. This document outlines the strategy to handle upgrades safely, with minimal downtime and automatic rollback capabilities.

---

## Key Principles

1. **Backward Compatibility:** Older client versions should work with newer server versions
2. **Zero-Downtime Upgrades:** Deploy new code without service interruption
3. **Automatic Migration:** Database schema migrations run automatically
4. **Rollback Safety:** Any version change can be rolled back to previous state
5. **Configuration Versioning:** Track which config version each instance is running

---

## Upgrade Paths

### Path 1: Development (Beta) Upgrade

**Scenario:** Office developers updating local development environment

```bash
# 1. Pull latest code
git pull origin main

# 2. Re-run setup wizard (idempotent; won't duplicate)
pnpm setup:beta

# 3. If needed, fresh start
docker-compose restart db
npm run migrate
pnpm dev
```

**Time:** 5-10 minutes  
**Risk:** Low (local data can be reset)  
**Downtime:** ~1 minute during migrations

---

### Path 2: Production In-Place Upgrade

**Scenario:** Customer on-premises; upgrade without Docker rebuild

```bash
# 1. Backup database
pg_dump "$INSIGHT_GEN_DB_URL" > backup-$(date +%Y%m%d).sql

# 2. Pull latest code
git pull origin main

# 3. Install new dependencies
pnpm install

# 4. Run migrations (safe to re-run)
npm run migrate

# 5. Restart application
# Stop old process or container
# Start new version
pnpm start
```

**Time:** 10-20 minutes  
**Risk:** Medium (database backup available)  
**Downtime:** ~2-5 minutes during migrations

---

### Path 3: Production Docker Upgrade

**Scenario:** Customer with Docker deployment; need new Docker image

```bash
# 1. Backup database
docker exec insight-gen-db pg_dump -U user insight_gen_db > backup.sql

# 2. Build new Docker image
./scripts/deploy.sh build

# 3. Export if distributing
./scripts/deploy.sh export

# 4. On customer server:
docker load < insight-gen.tar
docker-compose up -d  # Pulls new version automatically
```

**Time:** 15-30 minutes  
**Risk:** Medium (database backup available)  
**Downtime:** ~2-5 minutes during restart

---

### Path 4: Blue-Green Upgrade (Zero-Downtime)

**Scenario:** Enterprise customer requiring zero downtime

```bash
# 1. Start new instance running new code
docker run --name insight-gen-new -p 3006:3005 insight-gen:new

# 2. Run migrations on shared database
docker exec insight-gen-new npm run migrate

# 3. Run smoke tests against new instance
curl http://localhost:3006/api/health

# 4. Switch load balancer from old to new
# Load balancer or reverse proxy redirects traffic

# 5. Stop old instance
docker stop insight-gen

# 6. Rename new instance
docker rename insight-gen-new insight-gen
```

**Time:** 10-15 minutes  
**Risk:** Low (old instance still running)  
**Downtime:** None (load balancer switches traffic)

---

## Database Schema Migration Strategy

### Principle: Non-Breaking Changes Only

All database migrations must be **backward compatible** with the previous version until officially deprecated.

```typescript
// Example: Backward-compatible column addition
// Version 1.0: Column doesn't exist
// Version 1.1: Add column with default value
// Version 2.0: Can require column

// Migration: Add new column with default
ALTER TABLE users ADD COLUMN feature_flag_v1_1 BOOLEAN DEFAULT false;
// Old code: Ignores column (compatible)
// New code: Can use column (enabled)
```

### Migration Versioning

Each migration file includes:
- **Sequential number** (000, 001, ...)
- **Timestamp** (when created)
- **Description** (what it changes)
- **Rollback instructions** (how to reverse)

```javascript
// migrations/049_add_optional_column.sql
/* 
  Migration: 049_add_optional_column
  Description: Add opt-in feature column
  Date: 2026-02-03
  
  Rollback: ALTER TABLE features DROP COLUMN experimental_mode;
  
  Backward Compatible: Yes (default value = false)
*/

ALTER TABLE features 
  ADD COLUMN experimental_mode BOOLEAN DEFAULT false;
```

### Running Migrations Safely

```bash
# 1. Backup first (always!)
pg_dump "$DB_URL" > backup.sql

# 2. Run migrations
npm run migrate

# 3. Verify
npm run check-tables

# 4. If error, rollback
psql "$DB_URL" < backup.sql
```

---

## Configuration Version Tracking

### Store Config Version with Deployment

```json
// .insight-gen-setup.json (generated by wizard)
{
  "version": "1.0.0",
  "mode": "production",
  "database": { ... },
  "providers": { ... },
  "createdAt": "2026-02-03T15:30:00Z",
  "migratedAt": "2026-02-03T15:35:00Z"
}
```

### Version Compatibility Matrix

```
App Version | Config Version | DB Version | Compatible?
------------|----------------|------------|------------
1.0.0       | 1.0            | v1-49      | ✅ Yes
1.1.0       | 1.0            | v1-49      | ✅ Yes (auto-upgrade)
1.1.0       | 1.0            | v1-52      | ⚠️ Warn (run migrations)
2.0.0       | 1.0            | v1-49      | ❌ No (requires upgrade)
```

---

## Rollback Strategy

### Scenario: Something Goes Wrong After Upgrade

```bash
# 1. Identify what broke
# - Application won't start
# - Database queries fail
# - Configuration mismatch

# 2. Stop current version
docker stop insight-gen
# OR: Kill process (Ctrl+C)

# 3. Restore from backup
# Database:
psql "$DB_URL" < backup-20260203.sql

# 4. Revert application code
git checkout previous-release-tag
pnpm install  # Reinstall dependencies from old version

# 5. Restart with old version
pnpm start
# OR: docker run -p 3005:3005 insight-gen:old

# 6. Verify
curl http://localhost:3005/api/health
```

**Important:** Always keep previous Docker image tags available.

```bash
# Tag releases before upgrading
docker tag insight-gen:latest insight-gen:v1.0.0
docker tag insight-gen:v1.0.0 insight-gen:backup-20260203
```

---

## Upgrade Communication

### Announcement to Users

**When releasing a new version:**

```markdown
# InsightGen v1.1.0 Released

## What's New
- Feature X
- Bug fix Y
- Performance improvement Z

## Upgrade Path

### For Beta Users
\`\`\`bash
pnpm setup:beta
\`\`\`

### For Production Users
See: [UPGRADE_GUIDE.md](./UPGRADE_GUIDE.md)

## Compatibility
- ✅ Compatible with v1.0.x deployments
- ✅ Automatic database migration
- ⏱️ Estimated upgrade time: 10 minutes
- ⏸️ Downtime: ~2 minutes during migration

## Support
Questions? See [DEPLOYMENT_TROUBLESHOOTING.md](./DEPLOYMENT_TROUBLESHOOTING.md)
```

---

## Monitoring Upgrades

### Metrics to Track

```typescript
interface UpgradeMetrics {
  startTime: Date;
  endTime: Date;
  duration: number;  // minutes
  status: 'success' | 'failed' | 'rolled_back';
  previousVersion: string;
  newVersion: string;
  issues: string[];  // Any problems encountered
}
```

### Health Check After Upgrade

```bash
#!/bin/bash
# Run these checks after upgrade

echo "1. API Health"
curl http://localhost:3005/api/health

echo "2. Database"
curl http://localhost:3005/api/db/status

echo "3. AI Providers"
curl http://localhost:3005/api/ai/status

echo "4. Admin Panel"
curl http://localhost:3005/admin -I

echo "5. Sample Query"
curl -X POST http://localhost:3005/api/insights/ask \
  -H "Content-Type: application/json" \
  -d '{"question":"test"}'
```

---

## Implementation: Auto-Upgrade Script

**To Build in Next Iteration:**

```typescript
// scripts/upgrade.ts
class UpgradeManager {
  async upgrade(fromVersion: string, toVersion: string): Promise<void> {
    // 1. Validate compatibility
    // 2. Create database backup
    // 3. Run migrations
    // 4. Update configuration
    // 5. Restart application
    // 6. Run health checks
    // 7. Log metrics
  }

  async rollback(toVersion: string): Promise<void> {
    // 1. Restore from backup
    // 2. Revert to previous code
    // 3. Restart application
  }

  async healthCheck(): Promise<HealthStatus> {
    // Test all critical systems
  }
}
```

**Usage:**
```bash
pnpm upgrade  # Interactive upgrade wizard
pnpm upgrade --from=1.0.0 --to=1.1.0  # Non-interactive
pnpm rollback --to=1.0.0  # Emergency rollback
```

---

## Deprecation Policy

### How We Deprecate Features

1. **Version N:** Feature works, announce deprecation
2. **Version N+1:** Feature works with warnings
3. **Version N+2:** Feature removed, documentation updated

Example:
```typescript
// Version 1.1 (deprecated)
if (config.oldFormat) {
  console.warn("⚠️  oldFormat is deprecated. Use newFormat instead.");
  config.newFormat = convertOldToNew(config.oldFormat);
}

// Version 1.2 (warning)
if (config.oldFormat) {
  console.error("❌ oldFormat no longer supported. See MIGRATION.md");
  throw new Error("Configuration upgrade required");
}
```

---

## Testing Upgrades

### Test Cases to Run

```bash
# Test 1: Fresh install works
rm -rf node_modules .next
pnpm install && pnpm build

# Test 2: Upgrade from previous version
git stash  # Save current changes
git checkout v1.0.0
# ... run old version ...
git checkout main
npm run migrate  # Should work

# Test 3: Rollback from new to old
# ... run new version, then rollback ...
git checkout v1.0.0
# Should still work

# Test 4: Configuration compatibility
# ... with old .env, new version should work ...
```

---

## Future: Automated Upgrade Service

**Possible next step:**

```typescript
// Centralized service that:
// 1. Detects new versions available
// 2. Plans upgrade automatically
// 3. Schedules during low-traffic window
// 4. Executes upgrade with zero downtime
// 5. Monitors health after upgrade
// 6. Auto-rollback if health checks fail
```

---

## Related Documentation

- `DEPLOYMENT_MANUAL.md` - Step-by-step deployment
- `DEPLOYMENT_TROUBLESHOOTING.md` - Common issues
- `README-DEPLOYMENT.md` - Quick start

---

**Status:** Proposed for v1.1.0  
**Owner:** DevOps Team  
**Next Review:** After v1.0.0 release
